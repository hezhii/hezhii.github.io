---
title: 数据库事务及锁机制
date: 2017-09-21 23:41:26
categories:
  - 补钙
tags:
  - Database
  - Concurrency
  - Transaction
---

昨天，在实际的开发过程中，有一个从数据库中取一条数据的操作，需要保证每条数据只会被取用一次。最终，通过数据库事务解决了该问题。在解决的过程中，可以说是重新的学习了一遍数据库锁机制和事务，补了个钙。

<!-- more -->

## 实现思路

首先，关于数据库表的设计，添加了一个 `is_used` 字段，用来是标记该条数据是否被使用过，其中为 `1` 时表示已使用，为 `0` 时表示尚未被使用。每次获取一条可用数据的同时，需要将该条数据的 `is_used` 字段置为 `1`，表示该条数据已经被使用了。在这种情况下，在多个获取数据的请求并发执行的过程中，可能前一个请求处理过程中还未来得及将 `is_used` 字段置为 `1`，下一个请求就到来，导致两个请求获取到同一条数据。

在一开始时，计划是通过在内存中维护一个队列，队列中缓存了部分可用的数据。当一个请求到来时，从队列中取出一个可用数据返回给客户端，并将该条数据在对应的 `is_used` 字段置为 `1`。通过这样的方式，将并发的取数操作变为了同步的队列操作，可以保证不会取到同一条数据。

不过，在开始实现时却考虑到是否可以从数据库层面实现这个问题？能不能确保获取一条数据并设置 `is_used` 字段为 `1` 的过程中，其他的请求不会取到该条数据？最后，突然想到了数据库的事务，因为事务具有原子性和隔离性，正好可以应对这种并发的情况。

## 数据库锁机制

## 事务

## 具体实现